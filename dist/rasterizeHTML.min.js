/*! rasterizeHTML.js - v1.2.4 - 2017-02-21
* http://www.github.com/cburgmer/rasterizeHTML.js
* Copyright (c) 2017 Christoph Burgmer; Licensed MIT */
!function(a,b){"function"==typeof define&&define.amd?define(["url","xmlserializer","sane-domparser-error","inlineresources"],function(c,d,e,f){return a.rasterizeHTML=b(c,d,e,f)}):"object"==typeof module&&module.exports?module.exports=b(require("url"),require("xmlserializer"),require("sane-domparser-error"),require("inlineresources")):a.rasterizeHTML=b(a.url,a.xmlserializer,a.sanedomparsererror,a.inlineresources)}(this,function(a,b,c,d){var e=function(a){"use strict";var b={},c=[];b.joinUrl=function(b,c){return b?a.resolve(b,c):c},b.getConstantUniqueIdFor=function(a){return c.indexOf(a)<0&&c.push(a),c.indexOf(a)},b.clone=function(a){var b,c={};for(b in a)a.hasOwnProperty(b)&&(c[b]=a[b]);return c};var d=function(a){return"object"==typeof a&&null!==a},e=function(a){return d(a)&&Object.prototype.toString.apply(a).match(/\[object (Canvas|HTMLCanvasElement)\]/i)};return b.parseOptionalParameters=function(a){var c={canvas:null,options:{}};return null==a[0]||e(a[0])?(c.canvas=a[0]||null,c.options=b.clone(a[1])):c.options=b.clone(a[0]),c},b}(a),f=function(a){"use strict";var b={},c=function(a,b,c){var d=a[b];return a[b]=function(){var a=Array.prototype.slice.call(arguments);return c.apply(this,[a,d])},d};return b.baseUrlRespectingXhr=function(b,d){var e=function(){var e=new b;return c(e,"open",function(b,c){var e=b.shift(),f=b.shift(),g=a.joinUrl(d,f);return c.apply(this,[e,g].concat(b))}),e};return e},b.finishNotifyingXhr=function(a){var b,d=0,e=0,f=!1,g=new Promise(function(a){b=function(){var b=d-e;b<=0&&f&&a({totalCount:d})}}),h=function(){var f=new a;return c(f,"send",function(a,b){return d+=1,b.apply(this,arguments)}),f.addEventListener("load",function(){e+=1,b()}),f};return h.waitForRequestsToFinish=function(){return f=!0,b(),g},h},b}(e),g=function(){"use strict";var a={},b=function(a){return Array.prototype.slice.call(a)};a.addClassName=function(a,b){a.className+=" "+b},a.addClassNameRecursively=function(b,c){a.addClassName(b,c),b.parentNode!==b.ownerDocument&&a.addClassNameRecursively(b.parentNode,c)};var c=function(a,c){var d=a.parentStyleSheet,e=b(d.cssRules).indexOf(a);d.insertRule(c,e+1),d.deleteRule(e)},d=function(a,b){var d=a.cssText.replace(/^[^\{]+/,""),e=b+" "+d;c(a,e)},e=function(a){return b(a).reduce(function(a,b){return a+b.cssText},"")},f=function(a){a.textContent=e(a.sheet.cssRules)},g=function(a){var b=document.implementation.createHTMLDocument(""),c=document.createElement("style");c.textContent=a.textContent,b.body.appendChild(c),a.sheet=c.sheet},h=function(a){return"((?:^|[^.#:\\w])|(?=\\W))("+a.join("|")+")(?=\\W|$)"},i=function(a,c,e){var i=h(c);b(a.querySelectorAll("style")).forEach(function(a){"undefined"==typeof a.sheet&&g(a);var c=b(a.sheet.cssRules).filter(function(a){return a.selectorText&&new RegExp(i,"i").test(a.selectorText)});c.length&&(c.forEach(function(a){var b=a.selectorText.replace(new RegExp(i,"gi"),function(a,b,c){return b+e(c)});b!==a.selectorText&&d(a,b)}),f(a))})};return a.rewriteCssSelectorWith=function(a,b,c){i(a,[b],function(){return c})},a.lowercaseCssTypeSelectors=function(a,b){i(a,b,function(a){return a.toLowerCase()})},a.findHtmlOnlyNodeNames=function(a){var b,c=a.ownerDocument.createTreeWalker(a,NodeFilter.SHOW_ELEMENT),d={},e={};do b=c.currentNode.tagName.toLowerCase(),"http://www.w3.org/1999/xhtml"===c.currentNode.namespaceURI?d[b]=!0:e[b]=!0;while(c.nextNode());return Object.keys(d).filter(function(a){return!e[a]})},a}(),h=function(a){"use strict";var b={},c=function(a){return Array.prototype.slice.call(a)},d={active:!0,hover:!0,focus:!1,target:!1};return b.fakeUserAction=function(b,c,e){var f=b.querySelector(c),g=":"+e,h="rasterizehtml"+e;f&&(d[e]?a.addClassNameRecursively(f,h):a.addClassName(f,h),a.rewriteCssSelectorWith(b,g,"."+h))},b.persistInputValues=function(a){var b=a.querySelectorAll("input"),d=a.querySelectorAll("textarea"),e=function(a){return"checkbox"===a.type||"radio"===a.type};c(b).filter(e).forEach(function(a){a.checked?a.setAttribute("checked",""):a.removeAttribute("checked")}),c(b).filter(function(a){return!e(a)}).forEach(function(a){a.setAttribute("value",a.value)}),c(d).forEach(function(a){a.textContent=a.value})},b.rewriteTagNameSelectorsToLowerCase=function(b){a.lowercaseCssTypeSelectors(b,a.findHtmlOnlyNodeNames(b))},b}(g),i=function(a,b,c,d){"use strict";var e={},f=function(a,b,c,d){var e=a.createElement(b);return e.style.visibility="hidden",e.style.width=c+"px",e.style.height=d+"px",e.style.position="absolute",e.style.top=-1e4-d+"px",e.style.left=-1e4-c+"px",a.getElementsByTagName("body")[0].appendChild(e),e},g=function(a){return a>0?new Promise(function(b){setTimeout(b,a)}):Promise.resolve()};e.executeJavascript=function(a,c){return new Promise(function(e){var h=f(d.document,"iframe",c.width,c.height),i=a.outerHTML,j=[],k=c.executeJsTimeout||0,l=function(){var a=h.contentDocument;d.document.getElementsByTagName("body")[0].removeChild(h),e({document:a,errors:j})},m=h.contentWindow.XMLHttpRequest,n=b.finishNotifyingXhr(m),o=b.baseUrlRespectingXhr(n,c.baseUrl);h.onload=function(){g(k).then(n.waitForRequestsToFinish).then(l)},h.contentDocument.open(),h.contentWindow.XMLHttpRequest=o,h.contentWindow.onerror=function(a){j.push({resourceType:"scriptExecution",msg:a})},h.contentDocument.write("<!DOCTYPE html>"),h.contentDocument.write(i),h.contentDocument.close()})};var h=function(a,b,c){var d=a.createElement("iframe");return d.style.width=b+"px",d.style.height=c+"px",d.style.visibility="hidden",d.style.position="absolute",d.style.top=-1e4-c+"px",d.style.left=-1e4-b+"px",d.sandbox="allow-same-origin",d.scrolling="no",d},i=function(a,b,c){var e=Math.floor(a/c),f=Math.floor(b/c);return h(d.document,e,f)},j=function(a,b,c,d){return{width:Math.max(a.width*d,b),height:Math.max(a.height*d,c)}},k=function(a,b){var c=a.querySelector(b);if(c)return c;if(a.ownerDocument.querySelector(b)===a)return a;throw{message:"Clipping selector not found"}},l=function(a,b,c,e,f){var g,h,i,l,m,n,o,p,q=Math.max(a.scrollWidth,a.clientWidth),r=Math.max(a.scrollHeight,a.clientHeight);return b?(n=k(a,b),o=n.getBoundingClientRect(),g=o.top,h=o.left,i=o.width,l=o.height):(g=0,h=0,i=q,l=r),p=j({width:i,height:l},c,e,f),m=d.getComputedStyle(a.ownerDocument.documentElement).fontSize,{left:h,top:g,width:p.width,height:p.height,viewportWidth:q,viewportHeight:r,rootFontSize:m}},m=function(a,b){var c=a.tagName;return b.querySelector(c)},n=function(a){var b=a.tagName.toLowerCase();return"html"===b||"body"===b?a.outerHTML:'<body style="margin: 0;">'+a.outerHTML+"</body>"};e.calculateDocumentContentSize=function(a,b){return new Promise(function(c,e){var f,g=b.zoom||1;f=i(b.width,b.height,g),d.document.getElementsByTagName("body")[0].appendChild(f),f.onload=function(){var h,i=f.contentDocument;try{h=l(m(a,i),b.clip,b.width,b.height,g),c(h)}catch(a){e(a)}finally{d.document.getElementsByTagName("body")[0].removeChild(f)}},f.contentDocument.open(),f.contentDocument.write("<!DOCTYPE html>"),f.contentDocument.write(n(a)),f.contentDocument.close()})},e.parseHtmlFragment=function(a){var b=d.document.implementation.createHTMLDocument("");b.documentElement.innerHTML=a;var c=b.querySelector("body").firstChild;if(!c)throw"Invalid source";return c};var o=function(a,b){var c,e,f,g,h=/<html((?:\s+[^>]*)?)>/im.exec(b),i=d.document.implementation.createHTMLDocument("");if(h)for(c="<div"+h[1]+"></div>",i.documentElement.innerHTML=c,f=i.querySelector("div"),e=0;e<f.attributes.length;e++)g=f.attributes[e],a.documentElement.setAttribute(g.name,g.value)};e.parseHTML=function(a){var b=d.document.implementation.createHTMLDocument("");return b.documentElement.innerHTML=a,o(b,a),b};var p=function(a){try{return c.failOnParseError(a)}catch(a){throw{message:"Invalid source",originalError:a}}};e.validateXHTML=function(a){var b=new DOMParser,c=b.parseFromString(a,"application/xml");p(c)};var q=null,r=function(a,b){return"none"===b||"repeated"===b?(null!==q&&"repeated"===b||(q=Date.now()),a+"?_="+q):a},s=function(b,c){return new Promise(function(d,e){var f=new window.XMLHttpRequest,g=a.joinUrl(c.baseUrl,b),h=r(g,c.cache),i=function(a){e({message:"Unable to load page",originalError:a})};f.addEventListener("load",function(){200===f.status||0===f.status?d(f.responseXML):i(f.statusText)},!1),f.addEventListener("error",function(a){i(a)},!1);try{f.open("GET",h,!0),f.responseType="document",f.send(null)}catch(a){i(a)}})};return e.loadDocument=function(a,b){return s(a,b).then(function(a){return p(a)})},e}(e,f,c,window),j=function(a){"use strict";var b,c={},d=function(a,b){return b?URL.createObjectURL(new Blob([a],{type:"image/svg+xml"})):"data:image/svg+xml;charset=utf-8,"+encodeURIComponent(a)},e=function(a){a instanceof Blob&&URL.revokeObjectURL(a)},f='<svg xmlns="http://www.w3.org/2000/svg" width="1" height="1"><foreignObject></foreignObject></svg>',g=function(a){return new Promise(function(b,c){var d=document.createElement("canvas"),e=new Image;e.onload=function(){var a=d.getContext("2d");try{a.drawImage(e,0,0),d.toDataURL("image/png"),b(!0)}catch(a){b(!1)}},e.onerror=c,e.src=a})},h=function(){var a=d(f,!0);return g(a).then(function(b){return e(a),!b&&g(d(f,!1)).then(function(a){return a})},function(){return!1})},i=function(){if(a.Blob)try{return new Blob(["<b></b>"],{type:"text/xml"}),!0}catch(a){}return!1},j=function(){return new Promise(function(b,c){i()&&a.URL?h().then(function(a){b(!a)},function(){c()}):b(!1)})},k=function(){return void 0===b&&(b=j()),b},l=function(a){return k().then(function(b){return d(a,b)})};return c.renderSvg=function(a){return new Promise(function(b,c){var d,f,g=function(){f.onload=null,f.onerror=null},h=function(){d&&e(d)};f=new Image,f.onload=function(){g(),h(),b(f)},f.onerror=function(){h(),c()},l(a).then(function(a){d=a,f.src=d},c)})},c}(window),k=function(a,b,c,d){"use strict";var e={},f=function(a,b){var c=b||1,d={width:a.width,height:a.height,"font-size":a.rootFontSize};return 1!==c&&(d.style="transform:scale("+c+"); transform-origin: 0 0;"),d},g=function(a){var b,c,d,e;b=Math.round(a.viewportWidth),c=Math.round(a.viewportHeight),d=-a.left,e=-a.top;var f={x:d,y:e,width:b,height:c};return f},h=function(a){var b=a.style||"";a.style=b+"float: left;"},i=function(a){a.externalResourcesRequired=!0},j=function(){return'<style scoped="">html::-webkit-scrollbar { display: none; }</style>'},k=function(a){var b=Object.keys(a);return b.length?" "+b.map(function(b){return b+'="'+a[b]+'"'}).join(" "):""},l=function(a,c,e){var l=d.serializeToString(a);b.validateXHTML(l);var m=g(c);return h(m),i(m),'<svg xmlns="http://www.w3.org/2000/svg"'+k(f(c,e))+">"+j()+"<foreignObject"+k(m)+">"+l+"</foreignObject></svg>"};return e.getSvgForDocument=function(a,b,d){return c.rewriteTagNameSelectorsToLowerCase(a),l(a,b,d)},e.drawDocumentAsSvg=function(a,d){return["hover","active","focus","target"].forEach(function(b){d[b]&&c.fakeUserAction(a,d[b],b)}),b.calculateDocumentContentSize(a,d).then(function(b){return e.getSvgForDocument(a,b,d.zoom)})},e}(e,i,h,b),l=function(a,b,c,d,e,f){"use strict";var g={},h=function(a){return{message:"Error rendering page",originalError:a}},i=function(a){return e.renderSvg(a).then(function(b){return{image:b,svg:a}},function(a){throw h(a)})},j=function(a,b){try{b.getContext("2d").drawImage(a,0,0)}catch(a){throw h(a)}},k=function(a,b){return d.drawDocumentAsSvg(a,b)},l=function(a,b,c){return d.drawDocumentAsSvg(a,c).then(i).then(function(a){return b&&j(a.image,b),a})},m=function(a,d){return b.executeJavascript(a,d).then(function(a){var b=a.document;return c.persistInputValues(b),{document:b,errors:a.errors}})};return g.getNormalizedSvg=function(b,c){var d;return d=a.clone(c),d.inlineScripts=c.executeJs===!0,f.inlineReferences(b,d).then(function(a){return c.executeJs?m(b,c).then(function(b){return{element:b.document.documentElement,errors:a.concat(b.errors)}}):{element:b,errors:a}}).then(function(a){return k(a.element,c)})},g.rasterize=function(b,c,d){var e;return e=a.clone(d),e.inlineScripts=d.executeJs===!0,f.inlineReferences(b,e).then(function(a){return d.executeJs?m(b,d).then(function(b){return{element:b.document.documentElement,errors:a.concat(b.errors)}}):{element:b,errors:a}}).then(function(a){return l(a.element,c,d).then(function(b){return{image:b.image,svg:b.svg,errors:a.errors}})})},g}(e,i,h,k,j,d),m=function(a,b,c){"use strict";var d={},e=function(a,b){var c=300,d=200,e=a?a.width:c,f=a?a.height:d,g=void 0!==b.width?b.width:e,h=void 0!==b.height?b.height:f;return{width:g,height:h}},f=function(b){var c,d=e(b.canvas,b.options);return c=a.clone(b.options),c.width=d.width,c.height=d.height,c};d.drawDocument=function(){var b=arguments[0],d=Array.prototype.slice.call(arguments,1),e=a.parseOptionalParameters(d),g=b.documentElement?b.documentElement:b;return c.rasterize(g,e.canvas,f(e))},d._getNormalizedSvg=function(){var b=arguments[0],d=Array.prototype.slice.call(arguments,1),e=a.parseOptionalParameters(d),g=b.documentElement?b.documentElement:b;return c.getNormalizedSvg(g,f(e))};var g=function(a,c,e){var f=b.parseHTML(a);return d.drawDocument(f,c,e)},h=function(a,c){var e=b.parseHTML(a);return d._getNormalizedSvg(e,c)};d.getNormalizedSvg=function(){var b=arguments[0],c=Array.prototype.slice.call(arguments,1),d=a.parseOptionalParameters(c);return h(b,d.options)},d.drawHTML=function(){var b=arguments[0],c=Array.prototype.slice.call(arguments,1),d=a.parseOptionalParameters(c);return g(b,d.canvas,d.options)};var i=function(b,c,d){var e=document.implementation.createHTMLDocument("");e.replaceChild(b.documentElement,e.documentElement);var f=d?a.clone(d):{};return d.baseUrl||(f.baseUrl=c),{document:e,options:f}},j=function(a,c,e){return b.loadDocument(a,e).then(function(b){var f=i(b,a,e);return d.drawDocument(f.document,c,f.options)})};return d.drawURL=function(){var b=arguments[0],c=Array.prototype.slice.call(arguments,1),d=a.parseOptionalParameters(c);return j(b,d.canvas,d.options)},d}(e,i,l);return m});